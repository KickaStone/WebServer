# 简易数据库连接池

## 1 概念

数据库连接池

数据库连接池是为了提高数据库操作效率，减少连接的开销而使用的一种技术。它是一种管理数据库连接的机制，允许多个客户端在需要时共享一组预先建立的数据库连接，而不是每次请求都创建和销毁数据库连接。

主要的特点是：连接复用，资源共享，实现并发

## 2 实现
1. 连接池
使用`list`双向链表实现，使用单例模式（懒汉）。
2. 连接RAII
使用RAII思想，创建时请求连接池获取连接，销毁时释放连接。

因为是共享资源，需要一些同步机制，包括锁和信号量
```c++
    locker lock; 
    sem reserve; 
```
锁用来保证同一时刻只有一个线程对连接池进行修改
信号量用来同步连接池可用链接的数量

下面主要是连接池的实现。

### 3 初始化

建立`MaxConn`个数据库链接，并将其存到`list`中，作为连接池

初始化信号量`reserve`为空闲连接数量`reserve = sem(m_FreeConn)`


### 3.1 获取数据库连接

1. wait(reserve) 等待信号量（有空闲连接）
2. 加锁
3. 弹出一个连接，修改变量
4. 解锁
5. 返回数据库连接

### 3.2 释放获取的连接

1. 加锁
2. 链接返回队列，修改变量
3. 解锁
4. post(reserve) 信号量+1 并唤醒等待的进程
5. 返回

### 3.3 销毁连接池

原始版本销毁连接池时并没有检查是否所有连接都已经归还，可能导致一些正在使用的连接没有被正确释放。
解决方法是添加一些检测机制，没有释放全部连接会产生Error Log。